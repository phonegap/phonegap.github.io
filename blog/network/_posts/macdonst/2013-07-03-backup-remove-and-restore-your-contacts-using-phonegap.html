--- 
title: Backup, Remove and Restore your Contacts using PhoneGap
date: 2013-07-03 13:14:00 Z
author: Simon MacDonald
status: publish
format: html
external: true
permalink: /admin/blog/2013-07-03-backup-remove-and-restore-your-contacts-using-phonegap
link: http://simonmacdonald.blogspot.com/2013/07/backup-remove-and-restore-your-contacts.html
type: post
---
<div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-cs_a2ro_P0Y/TkA8D-vPCVI/AAAAAAAABwE/gHJwh4m8Jkw/s1600/pg.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-cs_a2ro_P0Y/TkA8D-vPCVI/AAAAAAAABwE/gHJwh4m8Jkw/s200/pg.png" width="159" /></a></div>A couple of people have had questions on how to do this recently so I thought I would do a write up on it. As well, it illustrates how you avoid using loops with asynchronous code. Although for an even better explanation of that topic you'll want to read <i>Item 64: Use Recursion for Asynchronous Loops</i> from <a href="https://twitter.com/littlecalculist">David Herman's</a> book, <a href="http://www.amazon.ca/gp/product/0321812182/ref=as_li_ss_tl?ie=UTF8&amp;camp=15121&amp;creative=390961&amp;creativeASIN=0321812182&amp;linkCode=as2&amp;tag=simmacsblo-20">Effective JavaScript</a>. Chapter 7 on <i>Concurrency</i> is worth the purchase price of the book but I digress...<br /><br />First a warning. Try all the code out on an emulator first. The methods below will completely wipe&nbsp;the contacts from your device so you'll want to make sure the backup step works first before continuing. You've been warned!<br /><br />Anyway, if you want to backup the contacts on your device to a file you'd use the following process:<br /><ol><li>Find all&nbsp;the contacts</li><li>Request a file system object</li><li>Create a FileEntry object</li><li>Create a FileWriter</li><li>Write&nbsp;the JSON data to file</li></ol>The code in which to accomplish those tasks is as follows: <script src="https://gist.github.com/macdonst/5917319.js?file=backup.js"></script>Once you see the <i>"backup complete"</i> message in the console you'll have a file called <i>"contacts.bak"</i> in the root directory of your file system. For Android users that will probably be /sdcard and for iOS, etc. it would be in the applications sandbox. If you take a look at&nbsp;the file you will see something like this: <script src="https://gist.github.com/macdonst/5917319.js?file=contacts.json"></script>If you are seeing what looks like your complete contact database in text format then you are ready to proceed. <br /><br />Next we will delete all the contacts on the device. The steps are: <br /><ol><li>Find all&nbsp;the contacts</li><li>Recurse through the contacts deleting one at a time.</li></ol><div>The code looks like:</div><script src="https://gist.github.com/macdonst/5917319.js?file=delete.js"></script><br />This might look a little bit weird at first glance but trust me it'll make sense. You'll notice in <b>deleteAllTheContacts</b> the first thing we do is to create a local function called <b>deleteContacts</b>. This is the method that will actually remove the contacts from the device. Then after the definition of <b>deleteContacts</b> we call navigator.contacts.find(). This call will get an array of all the contacts on the device and call it's success function which is <b>deleteContacts</b>.<br /><br />Now in <b>deleteContacts</b> we do a check to see if the length of the contacts array is zero. If it is zero then we are done, there are no more contacts left to be deleted. If the contact array length is greater than zero we have more work to do. We'll pop the next <b>Contact</b> object off of&nbsp;the contacts array, which reduces the size of the array by one and we'll call the <b>remove</b> method of the <b>Contact</b> object. The success call back for <b>remove</b> method is the <b>deleteContacts</b> method. Keep reading this paragraph until all of your contacts have been deleted. Boom recursion.<br /><br />But wait, you are wondering how could this possibly work. Your thinking I've got 7 quintillion contacts and there is no way the call stack can support that many&nbsp;recursive&nbsp;calls. Ah, but you are forgetting that asynchronous calls return immediately so they never eat up the call stack. If you tried doing this with a for loop you would blow up the call stack causing your program to crash if you had enough contacts and even if you didn't kill your app how would you know when all of those async calls to <b>remove</b> were complete without doing a lot of JavaScript gymnastics. Just use the recursion approach.<br /><br />Finally you'll want to be able to restore the contacts you've previously saved to file. I've broken it down into two separate methods to make it easier to read:<br /><ol><li>Request local file system</li><li>Get&nbsp;the FileEntry</li><li>Request the File object</li><li>Read the data and parse it to JSON</li><li>Recurse through all&nbsp;the contacts and save them to the device</li></ol><script src="https://gist.github.com/macdonst/5917319.js?file=restore.js"></script><br />This is pretty much just unrolling the two previous steps of backing up and deleting the contacts. If you've gotten this far you should be able to understand what is going on. Although there are two lines I want to draw your attention to: <blockquote class="tr_bq">contactData.id = null;<br/>contactData.rawId = null; </blockquote>What I'm doing here is removing the unique ID's from the contact. If you skip this step you will signal the API that you are attempting to modify an existing contact and the save will most probably fail.  Hopefully this helps a bunch of folks.
